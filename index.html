<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICF Collect | DHIS2 & Google Sheets Integration</title>
    <meta name="theme-color" content="#004080">
    <link rel="apple-touch-icon" href="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* All your existing CSS remains exactly the same */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Oswald', Arial, sans-serif; background: #f5f5f5; min-height: 100vh; }
        
        /* Auth Styles */
        .auth-container { min-height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #004080 0%, #001a33 100%); padding: 20px; }
        .auth-box { background: white; border-radius: 12px; width: 100%; max-width: 420px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .auth-header { background: #004080; color: white; padding: 25px; text-align: center; }
        .auth-header img { width: 80px; border-radius: 10px; margin-bottom: 12px; display: block; margin-left: auto; margin-right: auto; }
        .auth-header h1 { font-size: 24px; margin-bottom: 5px; }
        .auth-header p { font-size: 12px; opacity: 0.9; }
        .auth-body { padding: 25px; }
        .auth-tabs { display: flex; margin-bottom: 20px; }
        .auth-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: 700; font-size: 13px; border-bottom: 3px solid #ddd; transition: all 0.2s; }
        .auth-tab.active { border-bottom-color: #004080; color: #004080; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .auth-group { margin-bottom: 15px; }
        .auth-label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; color: #333; }
        .auth-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 14px; }
        .auth-input:focus { outline: none; border-color: #004080; }
        .auth-btn { width: 100%; padding: 14px; background: #004080; color: white; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 14px; cursor: pointer; }
        .auth-error { background: #ffebee; color: #c62828; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: none; }
        .auth-success { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: none; }
        
        /* Header */
        .header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .header-brand { display: flex; align-items: center; gap: 12px; }
        .header-logo { width: 45px; height: 45px; border-radius: 8px; }
        .header h1 { font-size: 20px; }
        .header-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .header-user { font-size: 12px; background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 20px; }
        .header-btn { background: white; color: #004080; border: none; padding: 10px 16px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 12px; cursor: pointer; }
        .header-btn.primary { background: #ffc107; color: #000; }
        .header-btn.success { background: #28a745; color: white; }
        .header-btn.danger { background: #dc3545; color: white; }
        .header-btn.dhis2 { background: #17a2b8; color: white; }
        .header-btn.sheets { background: #0f9d58; color: white; }
        
        /* Main Layout */
        .main-container { display: none; margin-top: 70px; height: calc(100vh - 100px); }
        .main-container.show { display: flex; }
        .footer { background: #004080; color: white; padding: 8px 20px; text-align: center; font-size: 11px; position: fixed; bottom: 0; left: 0; right: 0; }
        
        /* Sidebar */
        .sidebar { width: 220px; background: white; border-right: 3px solid #004080; overflow-y: auto; padding: 15px; }
        .sidebar-section { margin-bottom: 15px; }
        .sidebar-title { font-size: 11px; font-weight: 700; color: #004080; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid #004080; text-transform: uppercase; }
        .field-type { background: #f8f9fa; border: 2px solid #ddd; border-radius: 8px; padding: 10px 12px; margin-bottom: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 600; }
        .field-type:hover { border-color: #004080; background: #e8f4fc; }
        .field-type.special { background: #e8f4fc; border-color: #17a2b8; }
        
        /* Canvas */
        .canvas-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .canvas-header { background: white; padding: 12px 20px; border-bottom: 3px solid #004080; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .form-title-input { font-size: 16px; font-weight: 700; border: 2px solid #ddd; padding: 8px 12px; border-radius: 6px; font-family: 'Oswald', sans-serif; width: 300px; }
        .canvas { flex: 1; overflow-y: auto; padding: 20px; background: #e9ecef; }
        .form-preview { max-width: 650px; margin: 0 auto; background: white; border: 4px double #004080; border-radius: 12px; min-height: 350px; }
        .form-preview-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 18px; text-align: center; border-radius: 8px 8px 0 0; }
        .form-preview-body { padding: 18px; min-height: 250px; }
        
        .drop-zone { border: 3px dashed #adb5bd; border-radius: 10px; padding: 40px; text-align: center; color: #6c757d; }
        .drop-zone.has-fields { border: none; padding: 0; }
        
        /* Form Fields */
        .form-field { background: white; border: 2px solid #dee2e6; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; }
        .form-field:hover { border-color: #004080; }
        .form-field.selected { border-color: #004080; border-width: 3px; box-shadow: 0 0 0 4px rgba(0,64,128,0.2); }
        .form-field.dhis2-field { background: #e8f4fc; border-color: #17a2b8; }
        .form-field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .form-field-label { font-weight: 700; font-size: 12px; color: #333; }
        .form-field-actions { display: flex; gap: 4px; }
        .field-action-btn { background: #e9ecef; border: 2px solid #adb5bd; cursor: pointer; font-size: 14px; padding: 6px 10px; border-radius: 6px; }
        .field-action-btn:hover { background: #004080; color: white; }
        .field-action-btn.delete { background: #dc3545; color: white; border-color: #dc3545; }
        .field-badge { padding: 3px 8px; border-radius: 12px; font-size: 9px; font-weight: 700; margin-left: 8px; }
        .field-badge.required { background: #f8d7da; color: #721c24; }
        .field-badge.dhis2 { background: #d1ecf1; color: #0c5460; }
        .field-badge.aggregate { background: #d4edda; color: #155724; }
        .field-badge.cascade { background: #e8f4fc; color: #004080; }
        .field-badge.calc { background: #fff3cd; color: #856404; }
        .form-field.cascade-field { border-left: 3px solid #17a2b8; }
        
        .section-divider { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 12px 16px; margin: 15px 0; border-radius: 8px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        
        /* Properties Panel */
        .properties-panel { width: 340px; background: white; border-left: 3px solid #004080; overflow-y: auto; padding: 15px; }
        .properties-title { font-size: 12px; font-weight: 700; color: #004080; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #004080; }
        .property-group { margin-bottom: 12px; }
        .property-label { display: block; font-size: 10px; font-weight: 700; color: #333; margin-bottom: 5px; text-transform: uppercase; }
        .property-input, .property-select { width: 100%; padding: 8px 10px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 12px; }
        .property-textarea { width: 100%; padding: 8px 10px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 11px; min-height: 60px; }
        .property-checkbox { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 11px; padding: 6px 0; }
        .property-checkbox input { width: 18px; height: 18px; }
        .no-selection { text-align: center; color: #868e96; padding: 40px 15px; }
        .prop-section { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 15px; }
        .prop-section-title { font-size: 11px; font-weight: 700; color: #004080; margin-bottom: 10px; }
        
        /* Logic Builder */
        .logic-rule { background: #fff; border: 2px solid #dee2e6; border-radius: 6px; padding: 10px; margin-bottom: 8px; position: relative; }
        .logic-rule.show { border-color: #28a745; background: #f0fff4; }
        .logic-rule.hide { border-color: #dc3545; background: #fff5f5; }
        .logic-rule-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .logic-rule-type { font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 4px; }
        .logic-rule-type.show { background: #28a745; color: white; }
        .logic-rule-type.hide { background: #dc3545; color: white; }
        .logic-rule-delete { background: none; border: none; color: #dc3545; cursor: pointer; font-size: 14px; padding: 2px 6px; }
        .logic-rule-row { display: flex; gap: 6px; align-items: center; margin-bottom: 6px; flex-wrap: wrap; }
        .logic-select { padding: 6px 8px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 11px; font-family: 'Oswald', sans-serif; }
        .logic-input { padding: 6px 8px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 11px; width: 70px; font-family: 'Oswald', sans-serif; }
        .logic-add-btn { background: #004080; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 10px; cursor: pointer; font-family: 'Oswald', sans-serif; font-weight: 700; }
        .logic-add-btn:hover { background: #003366; }
        .logic-add-condition { background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 9px; cursor: pointer; margin-top: 5px; }
        .logic-connector { font-size: 10px; font-weight: 700; color: #6c757d; padding: 2px 6px; background: #e9ecef; border-radius: 3px; }
        
        /* Validation */
        .validation-rule { background: #fff3cd; border: 2px solid #ffc107; border-radius: 6px; padding: 10px; margin-bottom: 8px; }
        .validation-msg { font-size: 10px; color: #856404; margin-top: 5px; }
        .field-hidden { display: none !important; }
        .section-hidden { display: none !important; }
        
        /* Calculation Button Styles */
        .calc-op-btn { background: #004080; color: white; border: none; padding: 8px 14px; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; min-width: 36px; }
        .calc-op-btn:hover { background: #002855; }
        .calc-num-btn { background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; cursor: pointer; }
        .calc-num-btn:hover { background: #545b62; }
        .field-error input, .field-error select, .field-error textarea { border-color: #dc3545 !important; }
        .field-error-msg { color: #dc3545; font-size: 10px; margin-top: 4px; }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 20px; overflow-y: auto; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 12px; max-width: 750px; width: 100%; border: 4px double #004080; max-height: 90vh; overflow-y: auto; }
        .modal-header { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .modal-header.sheets { background: linear-gradient(135deg, #0f9d58 0%, #0b8043 100%); }
        .modal-header.primary { background: linear-gradient(135deg, #004080 0%, #002855 100%); }
        .modal-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .modal-body { padding: 20px; }
        .modal-btn { padding: 12px 24px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 13px; cursor: pointer; border: none; }
        .modal-btn.primary { background: #004080; color: white; }
        .modal-btn.success { background: #28a745; color: white; }
        .modal-btn.danger { background: #dc3545; color: white; }
        .modal-btn.dhis2 { background: #17a2b8; color: white; }
        .modal-btn.sheets { background: #0f9d58; color: white; }
        .modal-btn.purple { background: #6f42c1; color: white; }
        .modal-btn.orange { background: #fd7e14; color: white; }
        
        /* Config Sections */
        .config-section { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .config-section.dhis2 { background: #e8f4fc; border-color: #17a2b8; }
        .config-section.sheets { background: #e6f4ea; border-color: #0f9d58; }
        .config-title { font-size: 13px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .config-title.dhis2 { color: #17a2b8; }
        .config-title.sheets { color: #0f9d58; }
        .config-input { width: 100%; padding: 10px 12px; border: 2px solid #dee2e6; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 13px; margin-bottom: 10px; }
        .config-input:focus { outline: none; border-color: #004080; }
        .config-label { display: block; font-size: 10px; font-weight: 700; color: #333; margin-bottom: 5px; text-transform: uppercase; }
        .config-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .help-text { font-size: 10px; color: #666; margin-top: 3px; font-style: italic; }
        
        /* Status */
        .status-badge { padding: 12px 15px; border-radius: 6px; font-size: 12px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .status-badge.connected { background: #d4edda; color: #155724; border: 2px solid #28a745; }
        .status-badge.disconnected { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; }
        .status-badge.syncing { background: #fff3cd; color: #856404; border: 2px solid #ffc107; }
        
        /* Sync Log */
        .sync-log { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto; margin-top: 15px; }
        .log-entry { padding: 3px 0; border-bottom: 1px solid #333; }
        .log-entry.error { color: #ff6b6b; }
        .log-entry.success { color: #51cf66; }
        .log-entry.warning { color: #ffd43b; }
        .log-entry.info { color: #74c0fc; }
        
        /* Share Modal */
        .qr-container { text-align: center; padding: 20px; }
        .qr-url { background: #f8f9fa; padding: 12px; border-radius: 6px; font-size: 10px; word-break: break-all; margin-top: 15px; max-height: 80px; overflow-y: auto; font-family: monospace; }
        .qr-actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        
        /* Notification */
        .notification { position: fixed; top: 70px; right: 20px; background: #28a745; color: white; padding: 12px 20px; border-radius: 8px; font-weight: 700; font-size: 12px; z-index: 3000; display: none; max-width: 350px; }
        .notification.show { display: block; }
        .notification.error { background: #dc3545; }
        .notification.info { background: #17a2b8; }
        .notification.warning { background: #ffc107; color: #333; }
        
        /* Viewer */
        .viewer-container { display: none; min-height: 100vh; background: #e9ecef; }
        .viewer-container.show { display: block; }
        .viewer-nav { background: linear-gradient(135deg, #004080 0%, #002855 100%); padding: 12px 20px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; position: sticky; top: 0; z-index: 100; }
        .viewer-back-btn { background: #dc3545; color: white; border: none; padding: 10px 18px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 12px; cursor: pointer; margin-right: 10px; }
        .viewer-nav-btn { padding: 10px 18px; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 12px; font-weight: 700; cursor: pointer; border: none; }
        .viewer-nav-btn.active { box-shadow: 0 0 0 3px rgba(255,255,255,0.5); }
        .connection-status { padding: 6px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; display: flex; align-items: center; gap: 5px; margin-left: auto; }
        .connection-status.online { background: #28a745; color: white; }
        .connection-status.offline { background: #dc3545; color: white; }
        .viewer-tab { display: none; padding: 20px; }
        .viewer-tab.active { display: block; }
        
        /* Form Viewer */
        .viewer-form { max-width: 650px; margin: 0 auto; }
        .viewer-form-box { background: white; border: 4px double #004080; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .viewer-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 25px; text-align: center; }
        .viewer-header img { width: 70px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .viewer-header h1 { font-size: 20px; margin-bottom: 5px; }
        .viewer-header p { font-size: 12px; opacity: 0.9; }
        .viewer-body { padding: 25px; }
        .viewer-field { margin-bottom: 18px; }
        .viewer-field-label { display: block; font-size: 12px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; color: #333; }
        .viewer-input { width: 100%; padding: 12px; border: 2px solid #004080; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 13px; }
        .viewer-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(0,64,128,0.2); }
        .viewer-radio-group { display: flex; flex-direction: column; gap: 8px; }
        .viewer-radio-option { display: flex; align-items: center; gap: 6px; padding: 10px 14px; border: 2px solid #dee2e6; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .viewer-radio-option:hover { border-color: #004080; background: #e8f4fc; }
        
        /* Page Navigation */
        .page-header { background: #e8f4fc; margin: -25px -25px 20px -25px; padding: 15px 25px; border-bottom: 2px solid #004080; }
        .page-indicator { display: inline-block; background: #004080; color: white; padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; margin-bottom: 8px; }
        .page-title { font-size: 16px; color: #004080; font-weight: 700; margin: 0; }
        .page-navigation { display: flex; justify-content: space-between; margin-top: 25px; padding-top: 20px; border-top: 2px solid #e9ecef; gap: 10px; flex-wrap: wrap; }
        .nav-btn { padding: 14px 28px; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; }
        .back-btn { background: #6c757d; color: white; }
        .next-btn { background: #004080; color: white; }
        .submit-btn { background: #28a745; color: white; }
        
        /* Draft Panel Styles */
        .draft-actions-bar { display: flex; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 2px dashed #dee2e6; flex-wrap: wrap; }
        .draft-save-btn, .draft-toggle-btn { padding: 10px 16px; border: 2px solid #6f42c1; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .draft-save-btn { background: #6f42c1; color: white; }
        .draft-save-btn:hover { background: #5a32a3; }
        .draft-toggle-btn { background: white; color: #6f42c1; }
        .draft-toggle-btn:hover { background: #f3f0ff; }
        .drafts-panel-wrapper { margin-top: 15px; border: 2px solid #6f42c1; border-radius: 8px; background: #f8f9fa; }
        .drafts-panel-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%); color: white; font-size: 12px; font-weight: 700; border-radius: 6px 6px 0 0; }
        .drafts-list { max-height: 250px; overflow-y: auto; }
        .draft-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #dee2e6; gap: 10px; }
        .draft-item:last-child { border-bottom: none; }
        .draft-item:hover { background: #e9ecef; }
        .draft-info { flex: 1; min-width: 0; }
        .draft-preview { font-size: 11px; font-weight: 600; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .draft-date { font-size: 9px; color: #868e96; margin-top: 2px; }
        .draft-actions { display: flex; gap: 6px; }
        .draft-btn { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .draft-btn.load { background: #17a2b8; color: white; }
        .draft-btn.load:hover { background: #138496; }
        .draft-btn.delete { background: #dc3545; color: white; }
        .draft-btn.delete:hover { background: #c82333; }
        
        /* Cascade Field Styles */
        .cascade-container { display: flex; flex-direction: column; gap: 12px; }
        .cascade-level { display: flex; flex-direction: column; gap: 4px; }
        .cascade-label { font-size: 10px; font-weight: 600; color: #004080; text-transform: uppercase; }
        .cascade-select { padding: 10px 12px; }
        .cascade-select:disabled { background: #e9ecef; cursor: not-allowed; opacity: 0.7; }
        
        /* Data Table */
        .data-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 15px; }
        .data-table th, .data-table td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
        .data-table th { background: #004080; color: white; font-weight: 700; font-size: 10px; position: sticky; top: 0; }
        .data-table tr:nth-child(even) { background: #f8f9fa; }
        .data-table tr:hover { background: #e8f4fc; }
        
        .sync-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; }
        .sync-badge.synced { background: #d4edda; color: #155724; }
        .sync-badge.pending { background: #fff3cd; color: #856404; }
        .sync-badge.failed { background: #f8d7da; color: #721c24; }
        
        /* Filter Panel */
        .filter-panel { background: linear-gradient(135deg, #004080 0%, #002855 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .filter-title { color: white; font-size: 14px; font-weight: 700; }
        .filter-toggle { background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-family: 'Oswald', sans-serif; font-size: 11px; }
        .filter-controls { display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end; }
        .filter-group { display: flex; flex-direction: column; gap: 4px; min-width: 140px; position: relative; }
        .filter-group.with-arrows { padding-left: 18px; padding-right: 18px; }
        .filter-arrow-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; border-radius: 3px; cursor: pointer; padding: 4px 3px; color: white; font-size: 10px; line-height: 1; }
        .filter-arrow-btn:hover { background: rgba(255,255,255,0.4); }
        .filter-arrow-btn.left { left: 0; }
        .filter-arrow-btn.right { right: 0; }
        .filter-label { color: rgba(255,255,255,0.9); font-size: 9px; font-weight: 700; text-transform: uppercase; }
        .filter-select, .filter-input { padding: 8px 10px; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 11px; }
        .filter-btn { padding: 8px 16px; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 11px; cursor: pointer; }
        .filter-btn.apply { background: #28a745; color: white; }
        .filter-btn.clear { background: #dc3545; color: white; }
        .filter-count { background: #ffc107; color: #000; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 700; margin-left: 8px; }
        
        /* Data View Tabs */
        .data-view-tabs { display: flex; gap: 0; margin-bottom: 20px; }
        .data-view-tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: 700; font-size: 13px; border: 2px solid #dee2e6; background: #f8f9fa; }
        .data-view-tab:first-child { border-radius: 8px 0 0 8px; }
        .data-view-tab:last-child { border-radius: 0 8px 8px 0; }
        .data-view-tab.active { background: #004080; color: white; border-color: #004080; }
        .data-view-tab.active.aggregate { background: #28a745; border-color: #28a745; }
        
        /* Dashboard */
        .dashboard-container { max-width: 1100px; margin: 0 auto; }
        .dashboard-header { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
        .dashboard-header img { width: 60px; border-radius: 8px; margin-bottom: 10px; }
        .dashboard-header h2 { font-size: 18px; margin-bottom: 5px; }
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #004080 0%, #002855 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-card.success { background: linear-gradient(135deg, #28a745 0%, #218838 100%); }
        .stat-card.warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #000; }
        .stat-card.info { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }
        .stat-card.purple { background: linear-gradient(135deg, #6f42c1 0%, #59359a 100%); }
        .stat-card .stat-value { font-size: 28px; font-weight: 700; }
        .stat-card .stat-label { font-size: 10px; opacity: 0.9; margin-top: 5px; }
        .chart-container { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 2px solid #e9ecef; }
        .chart-container h4 { color: #004080; font-size: 14px; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #004080; }
        .chart-wrapper { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        .chart-box { flex: 1; min-width: 280px; max-width: 400px; }
        
        /* Aggregate Table */
        .aggregate-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .aggregate-table th { background: #28a745; color: white; padding: 12px; text-align: left; font-size: 11px; }
        .aggregate-table td { border: 1px solid #dee2e6; padding: 10px; }
        .aggregate-table tr:nth-child(even) { background: #f8f9fa; }
        .aggregate-table tr:hover { background: #e8f4fc; }
        
        /* GPS Map */
        .gps-map-container { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 2px solid #e9ecef; }
        .gps-map-container h4 { color: #004080; font-size: 14px; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #004080; display: flex; align-items: center; gap: 8px; }
        #gpsMap { height: 400px; border-radius: 8px; border: 1px solid #dee2e6; }
        .map-controls { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .map-legend { background: white; padding: 10px; border-radius: 6px; font-size: 11px; box-shadow: 0 1px 5px rgba(0,0,0,0.2); }
        .map-legend-item { display: flex; align-items: center; gap: 6px; margin: 4px 0; }
        .map-legend-color { width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 2px rgba(0,0,0,0.3); }
        .leaflet-popup-content { font-family: 'Oswald', Arial, sans-serif; font-size: 12px; }
        .leaflet-popup-content strong { color: #004080; }
        
        /* Inline Icons */
        .inline-icon { display: inline-flex; align-items: center; vertical-align: middle; margin-right: 4px; }
        .inline-icon svg { display: block; }
        
        /* Auth Loading Spinner */
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #004080; border-radius: 50%; border-top-color: transparent; animation: spin 0.8s linear infinite; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .aggregate-value { font-weight: 700; color: #004080; }
        
        /* Sync Mode Selector */
        .sync-mode-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .sync-mode-option { flex: 1; padding: 15px; border: 3px solid #dee2e6; border-radius: 8px; cursor: pointer; text-align: center; }
        .sync-mode-option:hover { border-color: #004080; }
        .sync-mode-option.selected { border-color: #004080; background: #e8f4fc; }
        .sync-mode-option.selected.tracker { border-color: #6f42c1; background: #f3e8ff; }
        .sync-mode-option h4 { font-size: 13px; margin-bottom: 5px; }
        .sync-mode-option p { font-size: 10px; color: #666; }
        
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar, .properties-panel { width: 100%; max-height: 200px; }
            .header { flex-wrap: wrap; padding: 10px 15px; }
            .header h1 { font-size: 16px; }
            .form-title-input { width: 100%; }
            .config-row { grid-template-columns: 1fr; }
            .dashboard-stats { grid-template-columns: repeat(2, 1fr); }
            .chart-box { min-width: 100%; }
            .filter-controls { flex-direction: column; }
            .filter-group { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Auth Container -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL">
                <h1>ICF Collect</h1>
                <p>DHIS2 & Google Sheets Integration</p>
            </div>
            <div class="auth-body">
                <div class="auth-tabs">
                    <div class="auth-tab active" data-tab="login">Login</div>
                    <div class="auth-tab" data-tab="signup">Sign Up</div>
                </div>
                <div class="auth-error" id="authError"></div>
                <div class="auth-success" id="authSuccess"></div>
                <div class="auth-loading" id="authLoading" style="display:none;text-align:center;padding:10px;color:#004080;">
                    <span class="spinner"></span> Please wait...
                </div>
                <form class="auth-form active" id="loginForm">
                    <div class="auth-group">
                        <label class="auth-label">Email / Username</label>
                        <input type="text" class="auth-input" id="loginEmail" required placeholder="your@email.com or username">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="loginPassword" required placeholder="Enter password">
                    </div>
                    <button type="submit" class="auth-btn"><span data-icon="unlock" data-size="14"></span> Login</button>
                    <div style="text-align:center;margin-top:12px;">
                        <a href="#" onclick="showForgotPassword()" style="color:#004080;font-size:12px;text-decoration:none;">Forgot Password?</a>
                    </div>
                </form>
                <form class="auth-form" id="signupForm">
                    <div class="auth-group">
                        <label class="auth-label">Full Name</label>
                        <input type="text" class="auth-input" id="signupName" required placeholder="John Doe">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Email / Username</label>
                        <input type="text" class="auth-input" id="signupEmail" required placeholder="your@email.com or username">
                    </div>
                    <div class="auth-group">
                        <label class="auth-label">Password</label>
                        <input type="password" class="auth-input" id="signupPassword" required minlength="6" placeholder="Min 6 characters">
                    </div>
                    <button type="submit" class="auth-btn"><span data-icon="user-plus" data-size="14"></span> Create Account</button>
                </form>
                <form class="auth-form" id="forgotForm">
                    <div class="auth-group">
                        <label class="auth-label">Enter your email/username</label>
                        <input type="text" class="auth-input" id="forgotEmail" required placeholder="your@email.com or username">
                    </div>
                    <button type="submit" class="auth-btn" style="background:#28a745;"><span data-icon="mail" data-size="14"></span> Send Password</button>
                    <div style="text-align:center;margin-top:12px;">
                        <a href="#" onclick="switchAuthTab('login')" style="color:#004080;font-size:12px;text-decoration:none;">Back to Login</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-brand">
            <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL" class="header-logo">
            <h1><span data-icon="clipboard-list" data-size="24"></span> ICF Collect</h1>
        </div>
        <div class="header-actions">
            <span class="header-user" id="headerUser"><span data-icon="user" data-size="14"></span> User</span>
            <button class="header-btn" onclick="showHome()"><span data-icon="home" data-size="14"></span> Home</button>
            <button class="header-btn" onclick="showShortUrls()"><span data-icon="link" data-size="14"></span> Short URLs</button>
            <button class="header-btn success" onclick="newForm()"><span data-icon="file-plus" data-size="14"></span> New</button>
            <button class="header-btn" onclick="saveCurrentForm()"><span data-icon="save" data-size="14"></span> Save</button>
            <button class="header-btn" onclick="previewForm()"><span data-icon="eye" data-size="14"></span> Preview</button>
            <button class="header-btn dhis2" onclick="openDhis2Config()"><span data-icon="link" data-size="14"></span> DHIS2</button>
            <button class="header-btn primary" onclick="shareForm()"><span data-icon="share-2" data-size="14"></span> Share</button>
            <button class="header-btn danger" onclick="logout()"><span data-icon="log-out" data-size="14"></span> Logout</button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container" id="mainContainer">
        <div class="sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title"><span data-icon="link" data-size="14"></span> DHIS2 Fields</h3>
                <div class="field-type special" data-type="period"><span data-icon="calendar-days" data-size="14"></span> Period (YYYYMM)</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title"><span data-icon="edit-3" data-size="14"></span> Basic Fields</h3>
                <div class="field-type" data-type="text"><span data-icon="type" data-size="14"></span> Text Input</div>
                <div class="field-type" data-type="number"><span data-icon="hash" data-size="14"></span> Number</div>
                <div class="field-type" data-type="calculation"><span data-icon="calculator" data-size="14"></span> Calculation</div>
                <div class="field-type" data-type="date"><span data-icon="calendar" data-size="14"></span> Date</div>
                <div class="field-type" data-type="time"><span data-icon="clock" data-size="14"></span> Time</div>
                <div class="field-type" data-type="email"><span data-icon="mail" data-size="14"></span> Email</div>
                <div class="field-type" data-type="phone"><span data-icon="phone" data-size="14"></span> Phone</div>
                <div class="field-type" data-type="textarea"><span data-icon="align-left" data-size="14"></span> Long Text</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title"><span data-icon="check-square" data-size="14"></span> Selection Fields</h3>
                <div class="field-type" data-type="select"><span data-icon="chevron-down-square" data-size="14"></span> Dropdown</div>
                <div class="field-type" data-type="radio"><span data-icon="circle-dot" data-size="14"></span> Radio Buttons</div>
                <div class="field-type" data-type="checkbox"><span data-icon="check-square" data-size="14"></span> Checkboxes</div>
                <div class="field-type" data-type="yesno"><span data-icon="toggle-left" data-size="14"></span> Yes / No</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title"><span data-icon="sparkles" data-size="14"></span> Special Fields</h3>
                <div class="field-type" data-type="gps"><span data-icon="map-pin" data-size="14"></span> GPS Location</div>
                <div class="field-type" data-type="qrcode"><span data-icon="qr-code" data-size="14"></span> QR/Barcode Scanner</div>
                <div class="field-type" data-type="cascade"><span data-icon="git-branch" data-size="14"></span> Cascading Dropdown</div>
                <div class="field-type" data-type="rating"><span data-icon="star" data-size="14"></span> Rating</div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title"><span data-icon="layout" data-size="14"></span> Structure</h3>
                <div class="field-type" data-type="section"><span data-icon="folder" data-size="14"></span> Section / Page</div>
            </div>
        </div>

        <div class="canvas-container">
            <div class="canvas-header">
                <input type="text" class="form-title-input" id="formTitle" value="My Data Collection Form" placeholder="Form Title...">

                <span style="color:#666;font-size:12px;font-weight:600;" id="fieldCount"><span data-icon="bar-chart-3" data-size="12"></span> 0 fields</span>
            </div>
            

            <div class="canvas">
                <div class="form-preview">
                    <div class="form-preview-header">
                        <h2 id="previewTitle">My Data Collection Form</h2>
                        <p>ICF-SL Data Collection System</p>
                    </div>
                    <div class="form-preview-body">
                        <div class="drop-zone" id="dropZone">
                            <p style="font-size:48px;margin-bottom:12px;"><span data-icon="mouse-pointer-click" data-size="48"></span></p>
                            <p style="font-weight:600;">Click field types to add them</p>
                            <p style="font-size:11px;color:#868e96;margin-top:10px;">Add Period + Org Unit fields for DHIS2 sync</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="properties-panel" id="propertiesPanel">
            <h3 class="properties-title"><span data-icon="settings" data-size="16"></span> Field Properties</h3>
            <div id="propertiesContent">
                <div class="no-selection">
                    <p style="font-size:32px;margin-bottom:12px;"><span data-icon="mouse-pointer-click" data-size="32"></span></p>
                    <p>Select a field to edit</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Viewer Container -->
    <div class="viewer-container" id="viewerContainer"></div>
    <div class="viewer-container" id="homeContainer"></div>
    
    <!-- Footer -->
    <footer class="footer">Â© 2025 Informatics Consultancy Firm - Sierra Leone (ICF-SL) | ICF Collect v3</footer>

    <!-- DHIS2 Configuration Modal -->
    <div class="modal-overlay" id="dhis2Modal">
        <div class="modal">
            <div class="modal-header">
                <h3><span data-icon="link" data-size="18"></span> DHIS2 Configuration</h3>
                <button class="modal-close" onclick="closeModal('dhis2Modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="dhis2Status" class="status-badge disconnected">
                    <span data-icon="x-circle" data-size="14"></span> <span>Not Connected</span>
                </div>
                
                <div class="config-section dhis2">
                    <div class="config-title dhis2"><span data-icon="globe" data-size="14"></span> Server Connection</div>
                    <label class="config-label">DHIS2 Server URL</label>
                    <input type="url" class="config-input" id="dhis2Url" placeholder="https://your-dhis2-instance.org">
                    
                    <div class="config-row">
                        <div>
                            <label class="config-label">Username</label>
                            <input type="text" class="config-input" id="dhis2Username" placeholder="Username">
                        </div>
                        <div>
                            <label class="config-label">Password</label>
                            <input type="password" class="config-input" id="dhis2Password" placeholder="Password">
                        </div>
                    </div>
                </div>
                
                <div class="config-section">
                    <div class="config-title"><span data-icon="refresh-cw" data-size="14"></span> Sync Mode</div>
                    <div class="sync-mode-selector">
                        <div class="sync-mode-option selected" data-mode="aggregate" onclick="selectSyncMode('aggregate')">
                            <h4><span data-icon="bar-chart-3" data-size="16"></span> Aggregate</h4>
                            <p>Creates Dataset + Data Elements</p>
                            <p style="font-size:9px;color:#004080;margin-top:4px;">Syncs summarized data by Facility/Period</p>
                        </div>
                        <div class="sync-mode-option" data-mode="tracker" onclick="selectSyncMode('tracker')">
                            <h4><span data-icon="clipboard-list" data-size="16"></span> Event Program</h4>
                            <p>Creates Program + Data Elements</p>
                            <p style="font-size:9px;color:#6f42c1;margin-top:4px;">Syncs each record as individual event</p>
                        </div>
                    </div>
                    
                    <div id="aggregateConfig">
                        <div class="config-row">
                            <div>
                                <label class="config-label">Period Column</label>
                                <select class="config-input" id="dhis2PeriodColumn">
                                    <option value="">-- Select field --</option>
                                </select>
                                <p class="help-text" style="font-size:10px;color:#666;margin-top:4px;">Field with period (YYYYMM)</p>
                            </div>
                            <div>
                                <label class="config-label">Org Unit Column</label>
                                <select class="config-input" id="dhis2OrgUnitColumn">
                                    <option value="">-- Select field --</option>
                                </select>
                                <p class="help-text" style="font-size:10px;color:#666;margin-top:4px;">Field with facility/org unit name</p>
                            </div>
                        </div>
                        <div class="config-row">
                            <div>
                                <label class="config-label">Org Unit Level</label>
                                <select class="config-input" id="dhis2OrgLevel">
                                    <option value="1">Level 1 (National)</option>
                                    <option value="2">Level 2 (Region)</option>
                                    <option value="3">Level 3 (District)</option>
                                    <option value="4">Level 4 (Chiefdom)</option>
                                    <option value="5" selected>Level 5 (Facility)</option>
                                    <option value="6">Level 6</option>
                                </select>
                            </div>
                            <div>
                                <label class="config-label">Period Type</label>
                                <select class="config-input" id="dhis2PeriodType">
                                    <option value="Monthly" selected>Monthly</option>
                                    <option value="Weekly">Weekly</option>
                                    <option value="Daily">Daily</option>
                                    <option value="Quarterly">Quarterly</option>
                                    <option value="Yearly">Yearly</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="trackerConfig" style="display:none;">
                        <label class="config-label">Program ID</label>
                        <input type="text" class="config-input" id="dhis2ProgramId" placeholder="Leave empty to auto-create, or enter existing Program ID">
                        <p class="help-text">Leave empty: Setup will create a new Event Program. Or enter an existing Program UID to use it.</p>
                    </div>
                </div>
                
                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;">
                    <button class="modal-btn dhis2" onclick="testDhis2Connection()"><span data-icon="search" data-size="14"></span> Test Connection</button>
                    <button class="modal-btn primary" onclick="saveDhis2Config()"><span data-icon="save" data-size="14"></span> Save Config</button>
                </div>
                
                <div class="config-section">
                    <div class="config-title"><span data-icon="rocket" data-size="14"></span> Setup & Sync Actions</div>
                    <p style="font-size:11px;color:#666;margin-bottom:15px;">
                        <strong>Setup DHIS2:</strong> Creates Dataset/Program and Data Elements<br>
                        <strong>Sync Case-Based:</strong> Pushes individual records as Events (Tracker)<br>
                        <strong>Sync Aggregate:</strong> Pushes aggregated data values (DataSets)
                    </p>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button class="modal-btn success" onclick="setupDhis2()" style="flex:1;"><span data-icon="settings" data-size="14"></span> Setup DHIS2</button>
                    </div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
                        <button class="modal-btn purple" onclick="syncCaseBased()" style="flex:1;"><span data-icon="list" data-size="14"></span> Sync Case-Based</button>
                        <button class="modal-btn" onclick="syncAggregate()" style="flex:1;background:#17a2b8;color:#fff;"><span data-icon="bar-chart-3" data-size="14"></span> Sync Aggregate</button>
                    </div>
                </div>
                
                <div class="sync-log" id="syncLog">
                    <div class="log-entry info">Ready...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal">
            <div class="modal-header primary">
                <h3><span data-icon="share-2" data-size="18"></span> Share Form</h3>
                <button class="modal-close" onclick="closeModal('shareModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="qr-container">
                    <div style="font-weight:700;color:#004080;margin-bottom:10px;"><span data-icon="link" data-size="14"></span> Share Link (Fixed Length)</div>
                    <div class="qr-url" id="shareUrl"></div>
                    <div style="margin-top:5px;font-size:10px;color:#28a745;">â Always 43 characters!</div>
                    <div class="qr-actions">
                        <button class="modal-btn primary" onclick="copyShareUrl()"><span data-icon="copy" data-size="14"></span> Copy URL</button>
                        <button class="modal-btn success" onclick="createNewShortUrl()"><span data-icon="refresh-cw" data-size="14"></span> Generate New</button>
                    </div>
                </div>
                
                <div style="background:#e3f2fd;padding:15px;border-radius:8px;margin-top:20px;">
                    <h4 style="color:#1565c0;margin:0 0 10px 0;"><span data-icon="info" data-size="14"></span> Fixed-Length URLs</h4>
                    <ul style="margin:0;padding-left:20px;font-size:12px;color:#333;">
                        <li>â Short format: <code>yourdomain.com/#abc123</code></li>
                        <li>â Always 43 characters total</li>
                        <li>â Stored locally in your browser</li>
                        <li>â No compression needed</li>
                        <li>â Works with all form features</li>
                    </ul>
                </div>
                
                <div style="background:#fff3cd;padding:15px;border-radius:8px;margin-top:10px;">
                    <h4 style="color:#856404;margin:0 0 5px 0;"><span data-icon="alert-triangle" data-size="14"></span> Storage Note</h4>
                    <p style="margin:0;font-size:12px;color:#856404;">Links are stored in your browser. For permanent storage, save to Google Sheets or backup your forms.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>
    
    <!-- Offline Indicator -->
    <div id="offlineIndicator" style="display:none;position:fixed;top:0;left:0;right:0;background:#dc3545;color:white;padding:8px;text-align:center;font-size:12px;font-weight:600;z-index:10000;">
        â ï¸ You are offline - Data will sync when back online
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
    // ==================== INLINE SVG ICONS ====================
    const icons = {
        'clipboard-list': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>',
        'home': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
        'file-plus': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>',
        'save': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>',
        'eye': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
        'link': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>',
        'share-2': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>',
        'log-out': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>',
        'user': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
        'user-plus': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>',
        'unlock': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>',
        'calendar': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
        'calendar-days': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>',
        'type': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>',
        'hash': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="20" y2="15"/><line x1="10" y1="3" x2="8" y2="21"/><line x1="16" y1="3" x2="14" y2="21"/></svg>',
        'clock': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
        'mail': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>',
        'phone': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',
        'align-left': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="17" y1="18" x2="3" y2="18"/></svg>',
        'chevron-down-square': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><polyline points="8 10 12 14 16 10"/></svg>',
        'circle-dot': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="1"/></svg>',
        'check-square': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>',
        'toggle-left': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="5" width="22" height="14" rx="7" ry="7"/><circle cx="8" cy="12" r="3"/></svg>',
        'map-pin': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>',
        'star': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
        'folder': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>',
        'text-cursor-input': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 4h1a3 3 0 0 1 3 3 3 3 0 0 1 3-3h1"/><path d="M13 20h-1a3 3 0 0 1-3-3 3 3 0 0 1-3 3H5"/><path d="M5 16H4a2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2h1"/><path d="M13 8h7a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-7"/><path d="M9 7v10"/></svg>',
        'sparkles': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>',
        'layout': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>',
        'download': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
        'settings': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
        'mouse-pointer-click': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 9 5 12 1.8-5.2L21 14Z"/><path d="M7.2 2.2 8 5.1"/><path d="m5.1 8-2.9-.8"/><path d="M14 4.1 12 6"/><path d="m6 12-1.9 2"/></svg>',
        'chevron-up': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>',
        'chevron-down': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>',
        'trash-2': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>',
        'globe': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>',
        'git-branch': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="6" y1="3" x2="6" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></svg>',
        'flask-conical': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></svg>',
        'rocket': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>',
        'refresh-cw': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>',
        'smartphone': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>',
        'copy': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>',
        'check-circle': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
        'cloud': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg>',
        'info': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>',
        'alert-triangle': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>',
        'x-circle': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
        'loader': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>',
        'database': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>',
        'building-2': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>',
        'bar-chart-3': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>',
        'inbox': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>',
        'plus': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
        'pencil': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>',
        'file-text': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
        'arrow-left': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>',
        'arrow-right': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>',
        'table': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>',
        'bar-chart-2': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
        'wifi': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>',
        'wifi-off': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>',
        'check': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
        'x': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
        'search': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
        'trending-up': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
        'edit-3': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>',
        'list': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>',
        'upload': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',
        'filter': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>',
        'layers': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>',
        'activity': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
        'file-spreadsheet': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>',
        'code': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',
        'qr-code': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="3" height="3"/><rect x="18" y="14" width="3" height="3"/><rect x="14" y="18" width="3" height="3"/><rect x="18" y="18" width="3" height="3"/></svg>',
        'scan': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><line x1="7" y1="12" x2="17" y2="12"/></svg>',
        'calculator': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="8" y2="10"/><line x1="12" y1="10" x2="12" y2="10"/><line x1="16" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="8" y1="18" x2="8" y2="18"/><line x1="12" y1="18" x2="12" y2="18"/><line x1="16" y1="18" x2="16" y2="18"/></svg>',
        'file-edit': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 13.5V4a2 2 0 0 1 2-2h8.5L20 7.5V20a2 2 0 0 1-2 2h-5.5"/><polyline points="14 2 14 8 20 8"/><path d="M10.42 12.61a2.1 2.1 0 1 1 2.97 2.97L7.95 21 4 22l1-3.95 5.42-5.44Z"/></svg>',
        'copy-check': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 15 2 2 4-4"/><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>'
    };
    
    function getIcon(name, size = 16) {
        const svg = icons[name] || icons['file-text'];
        return svg.replace(/width="24"/g, `width="${size}"`).replace(/height="24"/g, `height="${size}"`);
    }
    
    function initIcons() {
        document.querySelectorAll('[data-icon]').forEach(el => {
            const name = el.getAttribute('data-icon');
            const size = el.getAttribute('data-size') || 16;
            el.innerHTML = getIcon(name, size);
        });
    }

    // ==================== CONFIGURATION ====================
    const CONFIG = {
        PROXY_URL: 'https://script.google.com/macros/s/AKfycbwC9lJdYj4askujDNO2GfK-Rqq02VBcr90NXhifgvpawboEK1YCyUfbi2GA2hFL2UghkA/exec',
        AUTH_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwC9lJdYj4askujDNO2GfK-Rqq02VBcr90NXhifgvpawboEK1YCyUfbi2GA2hFL2UghkA/exec',
        LOGO_URL: 'https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg'
    };

    // ==================== STORAGE HELPERS ====================
    const memoryStorage = {};
    let storageAvailable = true;
    let storageWarningShown = false;
    
    try {
        localStorage.setItem('__test__', '1');
        localStorage.removeItem('__test__');
    } catch (e) {
        storageAvailable = false;
        console.warn('localStorage not available:', e.message);
    }

    const safeStorage = {
        getItem: function(key) {
            if (!storageAvailable) {
                return memoryStorage[key] || null;
            }
            try {
                return localStorage.getItem(key);
            } catch (e) {
                console.warn('Storage read error:', e);
                return memoryStorage[key] || null;
            }
        },
        setItem: function(key, value) {
            memoryStorage[key] = value;
            if (!storageAvailable) {
                if (!storageWarningShown) {
                    storageWarningShown = true;
                    setTimeout(() => {
                        if (typeof notify === 'function') {
                            notify('â ï¸ Storage blocked by browser. Data stored in memory only - will be lost on refresh. Host file on a web server for persistence.', 'warning');
                        }
                    }, 2000);
                }
                return;
            }
            try {
                localStorage.setItem(key, value);
            } catch (e) {
                console.warn('Storage write error:', e);
            }
        },
        removeItem: function(key) {
            delete memoryStorage[key];
            if (!storageAvailable) return;
            try {
                localStorage.removeItem(key);
            } catch (e) {
                console.warn('Storage remove error:', e);
            }
        }
    };

    // ==================== PROXY CONFIGURATION ====================
    const PROXIES = [
        { name: 'Direct', url: '', type: 'direct' },
        { name: 'GAS Proxy', url: 'https://script.google.com/macros/s/AKfycbx68uwmC6Hb7Vp5VGrOsUVNcOe0pzB8j8MBBHEDoIifVL6QC_3S7U0OldnhhzCwzUPMeg/exec', type: 'gas' },
        { name: 'CORS Proxy 1', url: 'https://corsproxy.io/?', type: 'cors' },
        { name: 'CORS Proxy 2', url: 'https://api.allorigins.win/raw?url=', type: 'cors' },
        { name: 'CORS Proxy 3', url: 'https://cors-anywhere.herokuapp.com/', type: 'cors' }
    ];

    function buildProxyUrl(proxy, targetUrl, auth, method) {
        if (proxy.type === 'direct') {
            return targetUrl;
        } else if (proxy.type === 'gas') {
            let proxyUrl = proxy.url + '?url=' + encodeURIComponent(targetUrl);
            if (auth) {
                proxyUrl += '&auth=' + encodeURIComponent(auth);
            }
            if (method && method !== 'GET') {
                proxyUrl += '&method=' + method;
            }
            return proxyUrl;
        } else {
            return proxy.url + encodeURIComponent(targetUrl);
        }
    }

    // ==================== GLOBAL STATE ====================
    const state = {
        user: null,
        fields: [],
        selectedFieldId: null,
        fieldCounter: 0,
        isSharedMode: false,
        settings: {
            title: 'My Data Collection Form',
            originalTitle: '',
            formId: '',
            logo: CONFIG.LOGO_URL,
            aggregateColumn: '',
            aggregateColumns: [],
            gpsField: ''
        },
        sheets: {
            scriptUrl: CONFIG.AUTH_SCRIPT_URL,
            sheetId: '',
            connected: true
        },
        dhis2: {
            url: '',
            username: '',
            password: '',
            syncMode: 'aggregate',
            orgUnitLevel: 5,
            periodType: 'Monthly',
            periodColumn: '',
            orgUnitColumn: '',
            programId: '',
            connected: false,
            datasetId: null,
            dataElements: {},
            orgUnits: [],
            orgUnitMap: {}
        },
        collectedData: [],
        filters: {},
        filterOrder: [],
        dateFilter: { start: '', end: '' },
        currentDataView: 'case',
        chartInstances: {}
    };

    const fieldDefs = {
        period: { label: 'Period', icon: 'calendar-days', defaultLabel: 'Reporting Period', valueType: 'TEXT', isDhis2: true, category: 'dhis2' },
        text: { label: 'Text', icon: 'type', defaultLabel: 'Text Field', valueType: 'TEXT', category: 'text' },
        number: { label: 'Number', icon: 'hash', defaultLabel: 'Number Field', valueType: 'NUMBER', category: 'numeric' },
        calculation: { label: 'Calculation', icon: 'calculator', defaultLabel: 'Calculated Field', valueType: 'NUMBER', category: 'numeric' },
        date: { label: 'Date', icon: 'calendar', defaultLabel: 'Date Field', valueType: 'DATE', category: 'date' },
        time: { label: 'Time', icon: 'clock', defaultLabel: 'Time Field', valueType: 'TIME', category: 'time' },
        email: { label: 'Email', icon: 'mail', defaultLabel: 'Email Address', valueType: 'TEXT', category: 'text' },
        phone: { label: 'Phone', icon: 'phone', defaultLabel: 'Phone Number', valueType: 'TEXT', category: 'text' },
        textarea: { label: 'Long Text', icon: 'align-left', defaultLabel: 'Long Text', valueType: 'LONG_TEXT', category: 'text' },
        select: { label: 'Dropdown', icon: 'chevron-down-square', defaultLabel: 'Dropdown', valueType: 'TEXT', category: 'categorical', options: ['Option 1', 'Option 2', 'Option 3'] },
        radio: { label: 'Radio', icon: 'circle-dot', defaultLabel: 'Radio Choice', valueType: 'TEXT', category: 'categorical', options: ['Option 1', 'Option 2', 'Option 3'] },
        checkbox: { label: 'Checkbox', icon: 'check-square', defaultLabel: 'Checkbox', valueType: 'TRUE_ONLY', category: 'categorical', options: ['Option 1', 'Option 2'] },
        yesno: { label: 'Yes/No', icon: 'toggle-left', defaultLabel: 'Yes/No Question', valueType: 'BOOLEAN', category: 'categorical' },
        gps: { label: 'GPS', icon: 'map-pin', defaultLabel: 'GPS Location', valueType: 'TEXT', category: 'text' },
        qrcode: { label: 'QR Code', icon: 'qr-code', defaultLabel: 'QR/Barcode Scanner', valueType: 'TEXT', category: 'text' },
        cascade: { label: 'Cascade', icon: 'git-branch', defaultLabel: 'Cascading Dropdown', valueType: 'TEXT', category: 'categorical', cascadeData: [], cascadeColumns: [] },
        rating: { label: 'Rating', icon: 'star', defaultLabel: 'Rating', valueType: 'INTEGER', category: 'categorical', max: 5 },
        section: { label: 'Section', icon: 'folder', defaultLabel: 'New Section', valueType: null, category: 'structure' }
    };

    // ==================== PERIODS ====================
    function generatePeriods() {
        const periods = [];
        for (let year = 2020; year <= 2026; year++) {
            for (let month = 1; month <= 12; month++) {
                periods.push(`${year}${String(month).padStart(2, '0')}`);
            }
        }
        return periods;
    }
    const PERIODS = generatePeriods();

    // ==================== NEW SHORT URL FUNCTIONS ====================
    function generateShortHash() {
        const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let hash;
        do {
            hash = '';
            for (let i = 0; i < 6; i++) {
                hash += chars.charAt(Math.floor(Math.random() * chars.length));
            }
        } while (localStorage.getItem('icfCollectShortForms') && 
                 JSON.parse(localStorage.getItem('icfCollectShortForms') || '{}')[hash]);
        
        return hash;
    }

    function saveFormWithHash(hash, formData) {
        const forms = JSON.parse(localStorage.getItem('icfCollectShortForms') || '{}');
        forms[hash] = formData;
        localStorage.setItem('icfCollectShortForms', JSON.stringify(forms));
        saveFormToGoogleSheetsBackup(hash, formData);
    }

    function loadFormFromHash(hash) {
        const forms = JSON.parse(localStorage.getItem('icfCollectShortForms') || '{}');
        let formData = forms[hash];
        
        if (!formData) {
            loadFormFromGoogleSheetsBackup(hash).then(backupData => {
                if (backupData) {
                    formData = backupData;
                    forms[hash] = formData;
                    localStorage.setItem('icfCollectShortForms', JSON.stringify(forms));
                    renderFormFromData(formData);
                } else {
                    document.getElementById('viewerContainer').innerHTML = `
                        <div style="text-align:center;padding:40px;color:#dc3545;">
                            <h3>Form not found</h3>
                            <p>The form with code <code>${hash}</code> doesn't exist or has expired.</p>
                            <button onclick="window.location='/'">Go Home</button>
                        </div>
                    `;
                }
            });
        } else {
            renderFormFromData(formData);
        }
    }

    function renderFormFromData(formData) {
        state.fields = formData.fields || [];
        state.settings = formData.settings || { title: formData.title || 'Form' };
        state.dhis2 = formData.dhis2 || {};
        
        document.getElementById('formTitle').value = state.settings.title;
        document.getElementById('previewTitle').textContent = state.settings.title;
        
        renderFormViewer();
    }

    async function saveFormToGoogleSheetsBackup(hash, formData) {
        try {
            await fetch(CONFIG.AUTH_SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'saveShortFormBackup',
                    hash: hash,
                    formData: formData,
                    timestamp: new Date().toISOString()
                })
            });
        } catch (err) {
            console.log('Cloud backup failed, but local storage works');
        }
    }

    async function loadFormFromGoogleSheetsBackup(hash) {
        try {
            const response = await fetch(`${CONFIG.AUTH_SCRIPT_URL}?action=getShortFormBackup&hash=${hash}`, {
                mode: 'cors'
            });
            const result = await response.json();
            if (result.success && result.formData) {
                return result.formData;
            }
        } catch (err) {
            console.log('Cloud load failed');
        }
        return null;
    }

    // NEW: Share form with fixed-length URL
    async function shareForm() {
        if (state.fields.length === 0) { 
            notify('Add fields!', 'error'); 
            return; 
        }
        
        const hash = generateShortHash();
        
        const formData = {
            title: state.settings.title,
            fields: state.fields.map(f => ({
                id: f.id,
                type: f.type,
                label: f.label,
                name: f.name,
                required: f.required,
                options: f.options,
                max: f.max,
                showLogic: f.showLogic,
                validation: f.validation,
                minLength: f.minLength,
                maxLength: f.maxLength,
                exactLength: f.exactLength,
                exactDigits: f.exactDigits,
                minDigits: f.minDigits,
                maxDigits: f.maxDigits,
                noFutureDates: f.noFutureDates,
                noPastDates: f.noPastDates,
                minDate: f.minDate,
                maxDate: f.maxDate,
                autoTime: f.autoTime,
                checkDuplicate: f.checkDuplicate,
                cascadeGroup: f.cascadeGroup,
                cascadeLevel: f.cascadeLevel,
                cascadeColumn: f.cascadeColumn,
                cascadeColumns: f.cascadeColumns,
                cascadeDataRef: f.cascadeDataRef,
                cascadeValueColumn: f.cascadeValueColumn,
                formula: f.formula
            })),
            settings: state.settings,
            dhis2: state.dhis2 ? {
                url: state.dhis2.url,
                username: state.dhis2.username,
                password: btoa(state.dhis2.password || ''),
                syncMode: state.dhis2.syncMode,
                orgUnitLevel: state.dhis2.orgUnitLevel,
                periodType: state.dhis2.periodType,
                periodColumn: state.dhis2.periodColumn,
                orgUnitColumn: state.dhis2.orgUnitColumn,
                programId: state.dhis2.programId
            } : null
        };
        
        saveFormWithHash(hash, formData);
        
        const baseUrl = window.location.origin + window.location.pathname;
        const shortUrl = baseUrl + '#' + hash;
        
        document.getElementById('shareUrl').textContent = shortUrl;
        document.getElementById('shareModal').classList.add('show');
        state.currentShortHash = hash;
        
        notify(`Short URL created! Length: ${shortUrl.length} characters`, 'success');
    }

    function createNewShortUrl() {
        if (!state.fields || state.fields.length === 0) {
            notify('No form to share', 'error');
            return;
        }
        
        const hash = generateShortHash();
        
        const formData = {
            title: state.settings.title,
            fields: state.fields.map(f => ({
                id: f.id,
                type: f.type,
                label: f.label,
                name: f.name,
                required: f.required,
                options: f.options
            })),
            settings: state.settings,
            dhis2: state.dhis2
        };
        
        saveFormWithHash(hash, formData);
        
        const baseUrl = window.location.origin + window.location.pathname;
        const shortUrl = baseUrl + '#' + hash;
        
        document.getElementById('shareUrl').textContent = shortUrl;
        state.currentShortHash = hash;
        
        notify('New URL generated!', 'success');
    }

    function showShortUrls() {
        const forms = JSON.parse(localStorage.getItem('icfCollectShortForms') || '{}');
        const baseUrl = window.location.origin + window.location.pathname;
        
        let html = '<div style="max-width:600px;margin:20px auto;">';
        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">';
        html += '<h2 style="color:#004080;"><span class="inline-icon">' + getIcon('link', 20) + '</span> Your Short URLs</h2>';
        html += '<button onclick="closeHome()" style="padding:10px 20px;background:#28a745;color:#fff;border:none;border-radius:6px;cursor:pointer;">Back to Builder</button>';
        html += '</div>';
        
        if (Object.keys(forms).length === 0) {
            html += '<div style="text-align:center;padding:40px;background:#f8f9fa;border-radius:8px;">';
            html += '<p style="font-size:48px;margin-bottom:12px;"><span class="inline-icon">' + getIcon('inbox', 48) + '</span></p>';
            html += '<p style="color:#666;">No short URLs created yet</p>';
            html += '<button onclick="shareForm()" style="margin-top:20px;padding:12px 24px;background:#004080;color:#fff;border:none;border-radius:6px;cursor:pointer;">Create Your First Short URL</button>';
            html += '</div>';
        } else {
            html += '<div style="background:#e8f4fc;padding:15px;border-radius:8px;margin-bottom:20px;">';
            html += '<p style="margin:0;font-size:12px;color:#004080;"><span class="inline-icon">' + getIcon('info', 14) + '</span> Each URL is exactly 6 characters + domain name. Always the same length!</p>';
            html += '</div>';
            
            Object.keys(forms).forEach(hash => {
                const form = forms[hash];
                const shortUrl = baseUrl + '#' + hash;
                const createdDate = form.createdAt ? new Date(form.createdAt).toLocaleDateString() : 'Unknown';
                
                html += `
                    <div style="background:#fff;padding:15px;margin-bottom:15px;border-radius:8px;border-left:4px solid #004080;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin:0 0 5px 0;font-size:16px;">${escapeHtml(form.title || 'Untitled')}</h3>
                        <div style="font-size:12px;color:#666;margin-bottom:8px;">
                            <span class="inline-icon">${getIcon('calendar', 12)}</span> Created: ${createdDate}
                            <span style="margin-left:10px;"><span class="inline-icon">${getIcon('bar-chart-3', 12)}</span> ${form.fields?.length || 0} fields</span>
                        </div>
                        <div style="background:#f1f3f5;padding:10px;border-radius:4px;font-family:monospace;margin-bottom:10px;word-break:break-all;">
                            ${shortUrl}
                        </div>
                        <div style="display:flex;gap:5px;flex-wrap:wrap;">
                            <button onclick="copyUrl('${shortUrl}')" style="padding:8px 15px;background:#004080;color:#fff;border:none;border-radius:4px;cursor:pointer;"><span class="inline-icon">${getIcon('copy', 12)}</span> Copy</button>
                            <button onclick="testUrl('${hash}')" style="padding:8px 15px;background:#28a745;color:#fff;border:none;border-radius:4px;cursor:pointer;"><span class="inline-icon">${getIcon('eye', 12)}</span> Preview</button>
                            <button onclick="deleteShortUrl('${hash}')" style="padding:8px 15px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;"><span class="inline-icon">${getIcon('trash-2', 12)}</span> Delete</button>
                        </div>
                    </div>
                `;
            });
        }
        
        html += '</div>';
        
        document.getElementById('homeContainer').innerHTML = html;
        document.querySelector('.header').style.display = 'none';
        document.getElementById('homeContainer').classList.add('show');
        initIcons();
    }

    function copyUrl(url) {
        navigator.clipboard.writeText(url);
        notify('Copied to clipboard!');
    }

    function testUrl(hash) {
        window.open(window.location.origin + window.location.pathname + '#' + hash, '_blank');
    }

    function deleteShortUrl(hash) {
        if (confirm('Delete this short URL? The form will no longer be accessible.')) {
            const forms = JSON.parse(localStorage.getItem('icfCollectShortForms') || '{}');
            delete forms[hash];
            localStorage.setItem('icfCollectShortForms', JSON.stringify(forms));
            showShortUrls();
            notify('Short URL deleted');
        }
    }

    // ==================== YOUR EXISTING AUTH FUNCTIONS ====================
    function checkAuth() {
        const saved = safeStorage.getItem('icfCollectUser');
        if (saved) { state.user = JSON.parse(saved); showBuilder(); }
    }

    function switchAuthTab(tab) {
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
        document.querySelector(`.auth-tab[data-tab="${tab}"]`)?.classList.add('active');
        document.getElementById(tab + 'Form')?.classList.add('active');
    }

    function showForgotPassword() {
        document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('forgotForm').classList.add('active');
        document.getElementById('authError').style.display = 'none';
        document.getElementById('authSuccess').style.display = 'none';
    }

    function showAuthLoading(show) {
        document.getElementById('authLoading').style.display = show ? 'block' : 'none';
        document.querySelectorAll('.auth-btn').forEach(btn => btn.disabled = show);
    }

    async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        
        document.getElementById('authError').style.display = 'none';
        showAuthLoading(true);
        
        try {
            const response = await fetch(CONFIG.AUTH_SCRIPT_URL, {
                method: 'POST', mode: 'cors', redirect: 'follow',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'login',
                    email: email,
                    password: password
                })
            });
            const result = await response.json();
            
            showAuthLoading(false);
            
            if (result.success && result.user) {
                state.user = result.user;
                safeStorage.setItem('icfCollectUser', JSON.stringify(result.user));
                showBuilder();
            } else {
                document.getElementById('authError').style.display = 'block';
                document.getElementById('authError').textContent = result.error || 'Invalid credentials';
            }
        } catch (error) {
            showAuthLoading(false);
            const users = JSON.parse(safeStorage.getItem('icfCollectUsers') || '[]');
            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                state.user = user;
                safeStorage.setItem('icfCollectUser', JSON.stringify(user));
                showBuilder();
            } else {
                document.getElementById('authError').style.display = 'block';
                document.getElementById('authError').textContent = 'Connection error. Please try again.';
            }
        }
    }

    async function handleSignup(e) {
        e.preventDefault();
        const name = document.getElementById('signupName').value.trim();
        const email = document.getElementById('signupEmail').value.trim();
        const password = document.getElementById('signupPassword').value;
        
        document.getElementById('authError').style.display = 'none';
        document.getElementById('authSuccess').style.display = 'none';
        showAuthLoading(true);
        
        try {
            const response = await fetch(CONFIG.AUTH_SCRIPT_URL, {
                method: 'POST', mode: 'cors', redirect: 'follow',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'signup',
                    name: name,
                    email: email,
                    password: password
                })
            });
            const result = await response.json();
            
            showAuthLoading(false);
            
            if (result.success) {
                const users = JSON.parse(safeStorage.getItem('icfCollectUsers') || '[]');
                if (!users.find(u => u.email === email)) {
                    users.push({ id: result.user?.id || Date.now().toString(), name, email, password });
                    safeStorage.setItem('icfCollectUsers', JSON.stringify(users));
                }
                
                document.getElementById('authSuccess').style.display = 'block';
                document.getElementById('authSuccess').textContent = 'Account created! Please login.';
                setTimeout(() => switchAuthTab('login'), 1500);
            } else {
                document.getElementById('authError').style.display = 'block';
                document.getElementById('authError').textContent = result.error || 'Registration failed';
            }
        } catch (error) {
            showAuthLoading(false);
            document.getElementById('authError').style.display = 'block';
            document.getElementById('authError').textContent = 'Connection error. Please try again.';
        }
    }

    async function handleForgotPassword(e) {
        e.preventDefault();
        const email = document.getElementById('forgotEmail').value.trim();
        
        document.getElementById('authError').style.display = 'none';
        document.getElementById('authSuccess').style.display = 'none';
        showAuthLoading(true);
        
        try {
            const response = await fetch(CONFIG.AUTH_SCRIPT_URL + '?action=forgotPassword&email=' + encodeURIComponent(email), {
                mode: 'cors',
                redirect: 'follow'
            });
            const result = await response.json();
            
            showAuthLoading(false);
            
            if (result.success) {
                document.getElementById('authSuccess').style.display = 'block';
                document.getElementById('authSuccess').textContent = 'Password sent to your email!';
                setTimeout(() => switchAuthTab('login'), 2000);
            } else {
                document.getElementById('authError').style.display = 'block';
                document.getElementById('authError').textContent = result.message || 'Email not found';
            }
        } catch (error) {
            showAuthLoading(false);
            document.getElementById('authError').style.display = 'block';
            document.getElementById('authError').textContent = 'Connection error. Please try again.';
        }
    }

    function showBuilder() {
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('mainContainer').classList.add('show');
        document.getElementById('headerUser').innerHTML = '<span data-icon="user" data-size="14"></span> ' + (state.user?.name || 'User');
        renderFields();
        initIcons();
    }

    function logout() {
        state.user = null;
        safeStorage.removeItem('icfCollectUser');
        document.getElementById('mainContainer').classList.remove('show');
        document.getElementById('authContainer').style.display = 'flex';
    }

    // ==================== UPDATED INIT FUNCTION ====================
    function init() {
        // Check for hash-based short URL first
        const hash = window.location.hash.substring(1);
        
        if (hash && hash.length === 6) {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('viewerContainer').classList.add('show');
            document.getElementById('viewerContainer').innerHTML = `
                <div style="display:flex;align-items:center;justify-content:center;height:100vh;flex-direction:column;">
                    <div style="font-size:48px;margin-bottom:20px;">â³</div>
                    <div style="color:#004080;font-weight:600;">Loading form <code>${hash}</code>...</div>
                </div>
            `;
            
            loadFormFromHash(hash);
            return;
        }
        
        // Check for compressed data (backward compatibility)
        const urlParams = new URLSearchParams(window.location.search);
        const compressedData = urlParams.get('d');
        
        if (compressedData) {
            try {
                const decoded = atob(decodeURIComponent(compressedData));
                const charData = decoded.split('').map(c => c.charCodeAt(0));
                const binData = new Uint8Array(charData);
                const decompressed = pako.inflate(binData, { to: 'string' });
                const data = JSON.parse(decompressed);
                
                const cacheKey = 'shared_form_' + window.location.search.substring(0, 100);
                try {
                    safeStorage.setItem(cacheKey, decompressed);
                } catch (e) {}
                
                state.isSharedMode = true;
                renderSharedForm(data);
                return;
            } catch (err) { 
                console.error('Decode error:', err);
                
                if (!navigator.onLine) {
                    const cacheKey = 'shared_form_' + window.location.search.substring(0, 100);
                    const cached = safeStorage.getItem(cacheKey);
                    if (cached) {
                        try {
                            const data = JSON.parse(cached);
                            state.isSharedMode = true;
                            renderSharedForm(data);
                            return;
                        } catch (e) {}
                    }
                }
            }
        }
        
        loadFromStorage();
        loadConfigs();
        setupEventListeners();
        checkAuth();
    }

    function setupEventListeners() {
        document.querySelectorAll('.auth-tab').forEach(tab => tab.addEventListener('click', () => switchAuthTab(tab.dataset.tab)));
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('signupForm').addEventListener('submit', handleSignup);
        document.getElementById('forgotForm').addEventListener('submit', handleForgotPassword);
        document.querySelectorAll('.field-type').forEach(el => el.addEventListener('click', () => addField(el.dataset.type)));
        document.getElementById('formTitle').addEventListener('input', (e) => {
            state.settings.title = e.target.value;
            document.getElementById('previewTitle').textContent = e.target.value;
            saveToStorage();
        });
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('show'); });
        });
    }

    // ==================== MAKE FUNCTIONS GLOBAL ====================
    window.init = init;
    window.shareForm = shareForm;
    window.createNewShortUrl = createNewShortUrl;
    window.showShortUrls = showShortUrls;
    window.copyUrl = copyUrl;
    window.testUrl = testUrl;
    window.deleteShortUrl = deleteShortUrl;
    window.switchAuthTab = switchAuthTab;
    window.showForgotPassword = showForgotPassword;
    window.logout = logout;
    window.showHome = showHome;
    window.newForm = newForm;
    window.saveCurrentForm = saveCurrentForm;
    window.previewForm = previewForm;
    window.openDhis2Config = openDhis2Config;
    window.closeModal = closeModal;
    window.selectSyncMode = selectSyncMode;
    window.testDhis2Connection = testDhis2Connection;
    window.saveDhis2Config = saveDhis2Config;
    window.setupDhis2 = setupDhis2;
    window.syncCaseBased = syncCaseBased;
    window.syncAggregate = syncAggregate;
    window.closeViewer = closeViewer;
    window.copyShareUrl = function() {
        navigator.clipboard.writeText(document.getElementById('shareUrl').textContent)
            .then(() => notify('Copied to clipboard!'))
            .catch(() => notify('Copy failed', 'error'));
    };
    window.captureGPS = captureGPS;
    window.setRating = setRating;
    window.startQRScanner = startQRScanner;
    window.stopQRScanner = stopQRScanner;
    window.goToNextPage = goToNextPage;
    window.goToPrevPage = goToPrevPage;
    window.showTab = showTab;
    window.updateFilter = updateFilter;
    window.updateDateFilter = updateDateFilter;
    window.clearAllFilters = clearAllFilters;
    window.moveFilter = moveFilter;
    window.refreshData = refreshData;
    window.downloadCSV = downloadCSV;
    window.switchDataView = switchDataView;
    window.toggleAggregateColumn = toggleAggregateColumn;
    window.setGpsField = setGpsField;
    window.zoomToAllPoints = zoomToAllPoints;
    window.downloadGeoJSON = downloadGeoJSON;
    window.downloadKML = downloadKML;
    window.saveDraft = saveDraft;
    window.loadDraft = loadDraft;
    window.deleteDraft = deleteDraft;
    window.toggleDraftsPanel = toggleDraftsPanel;
    window.handleCascadeSelect = handleCascadeSelect;
    window.handleCascadeChange = handleCascadeChange;
    window.downloadCascadeTemplate = downloadCascadeTemplate;
    window.handleCascadeUpload = handleCascadeUpload;
    window.insertFieldRef = insertFieldRef;
    window.insertFormulaText = insertFormulaText;
    window.clearFormula = clearFormula;
    window.addLogicRule = addLogicRule;
    window.deleteLogicRule = deleteLogicRule;
    window.addLogicCondition = addLogicCondition;
    window.deleteLogicCondition = deleteLogicCondition;
    window.updateLogicCondition = updateLogicCondition;
    window.addValidationRule = addValidationRule;
    window.deleteValidationRule = deleteValidationRule;
    window.updateValidationRule = updateValidationRule;
    window.updateFieldValidation = updateFieldValidation;

    // ==================== INITIALIZE ====================
    // Start the app
    init();
    initIcons();
    updateOnlineStatus();
</script>   
</body>
</html>
